# Lidar on the VacRob

[Home](../../../README.md) | [Project main page](../../vacrob.md) | [Computer module/raspi doc](../raspi.md) | [Touch screen doc](./touchscreen/touchscreen.md)

One of the main sensors that are placed on the robot is a lidar. This works by emitting a laser pulse and calculating the time it takes to get back (light sensor). The whole device spins, which allows to get distance measurements on a whole plane with a high resolution (1 pt/degree). The lidar that we use is the **Neato XV11 Lidar** (that is found on the neato vacuum robots).

## Some specifications

**Neato XV11 lidar:**

- 360 points per rotation
- controlled through UART (RX/TX)
- around 100 USD

## Position and fixation on the VacRob

The lidar is placed on the robot's top, about 15 cm away from it's center. It is fixed with spacers and 4 M3 screws. The laser is at a height of about 20 cm above the ground. This could be a problem to detect very low objects, but the distance modules should compensate this a little.

## Wiring

<img src="./neato-pinout.png" alt="neato lidar pinout" class="center">

Neato lidar pinout

They are 6 cables to connect.

**Computer module:**

- **Motor:** GND and 4.2V
  - GND: H102, pin 28
  - 5V: H102, pin 30 -> to make 4.2V from 5V, we solder a N4148 diode on the jump cable that goes to the + pin of the motor -> 0.7V drop
- **Comms:** RX and TX (solder 0 Ohm resistors on JP111 and JP112)
  - RX: H10, pin 39
  - TX: H101, pin 40
- **Lidar power:** GND and 5V
- - GND: H102, pin 25
  - 5V: H102, pin 29

## Reading data from serial

First setup:

- we connect the robot computer to an external screen, keyboard and mouse
- we get internet through an Ethernet cable
- we power the raspberry through micro usb -> this also powers the lidar and the lidar motor

More advanced setup:

- Raspberry powered by micro USB
- Raspberry hosting VNC server
- computer connected to the VNC server to see and act on what's on the touch screen of the raspi

We use the `screen` command to see if there is any data on the serial bus. `screen` takes two arguments: port and baud rate!

```bash
screen /dev/ttyAMA0 115200
```

To see all the serial devices that are accessible, use this bash command:

```bash
dmesg | grep tty
```

**Remark:** This (`screen`) did not work with the first lidar we had -> black screen showing up, or screen terminating immediately. Indeed, we used the oscilloscope to verify the logic level of the data on the serial bus, and it was 5 volts: a lot too high for the 3.3V raspi -> the serial port is probably broken.

To overcome this problem, we use a serial USB dongle plugged in the raspberry pi. The RX and TX lines were just plugged in the corresponding header pins, as shown underneath.

<img src="./usb-serial-dongle.jpg" width="50%" alt="serial over USB dongle" class="center">

This allowed us to `screen` the lidar, which is now on `ttyUSB0`.

```bash
screen /dev/ttyUSB0
```

This time, some weird characters showed up in the terminal, which shows that the communication was received (even though the baud rate was wrong).

## Plotting data in `rviz`

Procedure to follow: [https://wiki.ros.org/xv_11_laser_driver/Tutorials/Running%20the%20XV-11%20Node](https://wiki.ros.org/xv_11_laser_driver/Tutorials/Running%20the%20XV-11%20Node)

Install driver package:

```bash
udo apt-get install ros-kinetic-xv-11-laser-driver
```

Build driver from source:

```bash
cd catkin_ws/src
git clone https://github.com/rohbotics/xv_11_laser_driver.git
cd ..
catkin_make
source devel/setup.bash
```

Launch ROS:

```bash
roscore
```

To kill ROS (it can be useful after some new installs), just use:

```bash
killall roscore
```

Finally, launch the lidar driver (in background):

```bash
rosrun xv_11_laser_driver neato_laser_publisher _port:=/dev/ttyUSB0 &
```

You should also create a reference frame for the lidar data to be shown:

```bash
rosrun tf static_transform_publisher 0 0 0 0 0 0 1 map my_fra 10 &
```

To see what the inputs that ROS detects are (very useful for debug):

```bash
rostopic list
```

In all the parameters listed, `/rpms` is the number of rotations per minute that the lidar does (it should be around 360!) and `/scan` is the data generated by the lidar.

```bash
rostopic echo /screen
```

Launch `rviz`:

```bash
rosrun rviz rviz
```

## To do every time `rviz` is run

Create frame called `neato_laser`:

```bash
rosrun tf static_transform_publisher 0 0 0 0 0 0 1 map neato_laser 10 &
```

Run lidar driver:

```bash
rosrun xv_11_laser_driver neato_laser_publisher _port:=/dev/ttyUSB0 &
```

Launch `rviz`:

```bash
rosrun rviz rviz
```

## Launch rviz config automatically at boot

### The actual solution

[https://askubuntu.com/questions/598195/how-to-add-a-script-to-startup-applications-from-the-command-line](https://askubuntu.com/questions/598195/how-to-add-a-script-to-startup-applications-from-the-command-line)

First, we created a bash script in the home directory, which contains the commands that need to be run after every reboot.

What it does:
- 9: creates a very basic map, that allows to show the lidar points in rviz
- 10: runs the lidar driver
- 11: launches rviz with an existing conf file

```bash
#!/bin/bash

# running the right rviz conf after reboot -> using startup applications (set up in ~/.config/autostart/)

# getting ros related commands
source /opt/ros/kinetic/setup.sh

# making sure the GUI is set up
xmessage "Click on the button to launch rviz"

rosrun tf static_transform_publisher 0 0 0 0 0 0 1 map neato_laser 10 &
rosrun xv_11_laser_driver neato_laser_publisher _port:=/dev/ttyUSB0 &
rosrun rviz rviz -d ~/.rviz/lidarFullScreen.rviz &
```

Then, we had to create the following file in `~/.config/autostart/`. The file name is `rvizAutoLaunch.sh.desktop`.

```bash
cd ~/.config/autostart/
vi rvizAutoLaunch.sh.desktop
```

Inside this file:
```bash
[Desktop Entry]
Type=Application
Exec="/home/ubuntu/rvizAutoLaunch.sh"
X-GNOME-Autostart-enabled=true
```

### All the troubles we had before

[https://askubuntu.com/questions/542953/command-not-running-in-rc-local-but-works-in-terminal](https://askubuntu.com/questions/542953/command-not-running-in-rc-local-but-works-in-terminal)

**Warning:** adding commands to the `rc.local` files did not work when we tried because the file is run as root and is therefore in a restricted environment.

Will using this command help (add at the beginning of script)???? It should fetch the ros related commands.
```bash
source /opt/ros/kinetic/setup.sh
```
The underneath script:
- creates a very basic map, that allows to show the lidar points in rviz
- runs the lidar driver
- launches rviz with an existing conf file

```bash
rosrun tf static_transform_publisher 0 0 0 0 0 0 1 map neato_laser 10 &
rosrun xv_11_laser_driver neato_laser_publisher _port:=/dev/ttyUSB0 &
rosrun rviz rviz -d /home/ubuntu/.rviz/lidarFullScreen.rviz
```

Check status of the service (for rc.local file):

```bash
sudo systemctl status rc-local.service
```

[https://askubuntu.com/questions/814/how-to-run-scripts-on-start-up](https://askubuntu.com/questions/814/how-to-run-scripts-on-start-up)

Create a bash script and add the path to it in the file opened when you run: 

```bash
crontab -e
```
You can use the `@reboot` option to run your script after every reboot.

Cron logs:
```bash
grep CRON /var/log/syslog
```

Something that looks pretty promising (systemd):
[https://forum.ubiquityrobotics.com/t/changing-start-up-nodes-in-pi-image/55](https://forum.ubiquityrobotics.com/t/changing-start-up-nodes-in-pi-image/55)

[https://forum.ubiquityrobotics.com/t/robot-upstart-add-launch-file/209/5](https://forum.ubiquityrobotics.com/t/robot-upstart-add-launch-file/209/5)

-> from this last blog:

" I edited magni-base, and added in two places in this file:
$ sudo nano /usr/sbin/magni-base

One for declaring a ROS ‘source’ ~ (near the top of the file)
source /home/ubuntu/SOMEWHERE_ws/devel/setup.bash

And, the other for the call to my launch file ~(near the bottom of the file)
roslaunch MYpackage MYlaunchfile.launch & ~(Don’t forget this ampersand)
MYPID=$!
log info "… $MYPID…"
echo $MYPID > $log_path/my_launch.pid

(REBOOT) ~ and it works. "

## Pop-up window with text

There are many possibilities among which `xmessage` and `zenity`.
```bash
xmessage "my message" -timeout 3

```
The `timeout` option makes the message disappear after x seconds.

```bash
zenity --info --text="Calculation complete"
```

## Links

- tutorial on how to test/use the lidar: [https://www.impulseadventure.com/elec/robot-lidar-neato-xv11.html](https://www.impulseadventure.com/elec/robot-lidar-neato-xv11.html)
- manage to visualize the data in ROS: [https://wiki.ros.org/xv_11_laser_driver/Tutorials/Running%20the%20XV-11%20Node](https://wiki.ros.org/xv_11_laser_driver/Tutorials/Running%20the%20XV-11%20Node)
- documentation about rviz: [https://github.com/cse481sp17/cse481c/wiki/Lab-11:-Visualizations-in-ROS-with-RViz](https://github.com/cse481sp17/cse481c/wiki/Lab-11:-Visualizations-in-ROS-with-RViz)
